{% from "question/macro.njk" import question with context %}
{% from "faq/macro.njk" import faq %}

{% macro autocompleteQuestion(config) %}
    {% set id = config.id if config.id else config.name %}
    {% set inputId = id + "-autocomplete" %}
    {% set errorMessageId = id + "-error" %}
    {% set questionHeadingId = id + "-heading" %}
    {% set faqId = id + "-faq" %}
    {% set faqIdSecondary = id + "-faq-secondary" %}
    {% set value=config.value or risk[config.name] %}
    {% set errorMessage=config.errorMessage or errors[config.name].msg %}
    {% set placeholder=config.placeholder or "Please selectâ€¦" %}
    {% set pii = true if not config.pii | safe | length else config.pii %}

    {% call question(
        id=id,
        heading=config.heading and config.heading | safe,
        secondaryText=config.secondaryText and config.secondaryText | safe,
        validity="invalid" if errorMessage,
        variant=config.variant,
        labelFor=inputId,
        hidden=config.hidden,
        visibilityHidden=config.visibilityHidden
    ) %}
        {% for f in config.primaryFaqs %}
            {% call faq(
                question=f.question and f.question | safe,
                id=faqId,
                ariaDescribedby=questionHeadingId
            ) %}
                {{ f.answer | safe }}
            {% endcall %}
        {% endfor %}

        <div id="{{id}}-container" ctm-autocomplete>
            <div class="autocomplete__wrapper">
                <div class="autocomplete__status"
                     style="border: 0px; clip: rect(0 0 0 0); height: 1px; margin-bottom: -1px; margin-right: -1px; overflow: hidden; padding: 0px; position: absolute; white-space: nowrap; width: 1px;">
                    <div id="{{ inputId }}__status--A" role="status" aria-atomic="true" aria-live="polite"></div>
                    <div id="{{ inputId }}__status--B" role="status" aria-atomic="true" aria-live="polite"></div>
                </div>
                <input aria-expanded="false" aria-owns="{{ inputId }}__listbox" aria-autocomplete="list"
                       autocomplete="off" class="autocomplete__input autocomplete__input--show-all-values"
                       id="{{ inputId }}" name="{{ config.name }}" placeholder="{{ placeholder }}" type="text"
                       role="combobox">
                <svg version="1.1" xmlns="http://www.w3.org/2000/svg" class="autocomplete__dropdown-arrow-down" focusable="false">
                    <g stroke="none" fill="none" fill-rule="evenodd">
                        <polygon fill="#000000" points="0 0 22 0 11 17"></polygon>
                    </g>
                </svg>
                <span id="function z(t){if(!t.element)throw new Error(&quot;element is not defined&quot;);if(!t.id)throw new Error(&quot;id is not defined&quot;);if(!t.source)throw new Error(&quot;source is not defined&quot;);Array.isArray(t.source)&amp;&amp;(t.source=G(t.source)),L(u(K,t),t.element)}"
                      style="display: none;">When autocomplete results are available use up and down arrows to review and enter to select.  Touch device users, explore by touch or with swipe gestures.</span>
            </div>
            <ul class="autocomplete__menu autocomplete__menu--overlay autocomplete__menu--hidden"
                id="{{ inputId }}__listbox" role="listbox" aria-labelledby="{{ inputId }}"
                aria-describedby="{{ errorMessageId }}">
            </ul>
        </div>

        {% if errorMessage %}
            <p class="error-message" id="{{ errorMessageId }}">
                {{ errorMessage }}
            </p>
        {% endif %}

        {% for f in config.secondaryFaqs %}
            {% call faq(
                question=f.question and f.question | safe,
                id=faqIdSecondary,
                ariaDescribedby=questionHeadingId
            ) %}
                {{ f.answer | safe }}
            {% endcall %}
        {% endfor %}

        <script>
        document.addEventListener("DOMContentLoaded", function () {
            const items = {{ config.options | dump | safe }};
            console.log('Items:', items); // Debug: Verify items are correct

            const autocompleteElement = document.querySelector('#{{ id }}-container');
            const inputElement = document.querySelector('#{{ inputId }}');
            const listElement = document.querySelector('#{{ inputId }}__listbox');

            const init = (defaultValue) => {
                accessibleAutocomplete({
                    element: autocompleteElement,
                    id: '{{ inputId }}',
                    name: '{{ config.name }}',
                    source: items,
                    showAllValues: true,
                    autoselect: false,
                    enhanceSelectElement: false,
                    displayMenu: 'overlay',
                    defaultValue: defaultValue,
                    placeholder: '{{ placeholder }}',
                    menuAttributes: {
                        'aria-labelledby': '{{ inputId }}',
                        'aria-describedby': '{{ errorMessageId }}'
                    }
                });
            };

            inputElement.addEventListener('keydown', function(event) {
                if (event.key === "ArrowDown") {
                    event.preventDefault();
                    const firstOption = listElement.querySelector('li');
                    if (firstOption) firstOption.focus();
                }
            });

            listElement.addEventListener('keydown', function(event) {
                if (event.key === "ArrowUp" && document.activeElement === listElement.firstChild) {
                    event.preventDefault();
                    inputElement.focus();
                }
            });

            init('{{ value }}');
        });
        </script>
    {% endcall %}
{% endmacro %}

{% macro render(config) %}
    {{ autocompleteQuestion(config) }}
{% endmacro %}
